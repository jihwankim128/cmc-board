<!DOCTYPE html>
<html layout:decorate="~{layout/default}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>북마크</title>
</head>
<body>
<div layout:fragment="content">
    <h2 class="mb-4">
        <i class="bi bi-bookmark-fill text-warning"></i> 북마크
    </h2>

    <div class="list-group" id="bookmarks-list">
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <script>
        $(document).ready(function () {
            loadBookmarks();
        });

        function loadBookmarks() {
            $.get('/api/bookmarks', function (response) {
                const bookmarks = response.data;

                if (bookmarks.length === 0) {
                    $('#bookmarks-list').html(`
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-bookmark" style="font-size: 3rem;"></i>
                    <p class="mt-3">북마크한 게시글이 없습니다.</p>
                    <a href="/posts" class="btn btn-primary mt-2">게시글 보러가기</a>
                </div>
            `);
                    return;
                }

                const bookmarksHtml = bookmarks.map(bookmark => {
                    const post = bookmark.post;
                    return `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <a href="/posts/${post.id}" class="text-decoration-none text-dark">
                                <div class="mb-2">
                                    <span class="badge bg-secondary me-2">${escapeHtml(post.category.name)}</span>
                                    <h5 class="d-inline mb-0">${escapeHtml(post.title)}</h5>
                                </div>
                                <p class="mb-2 text-muted text-truncate">${escapeHtml(post.content)}</p>
                                <small class="text-muted">
                                    <i class="bi bi-person"></i> ${escapeHtml(post.author.nickname)}
                                    <span class="mx-2">•</span>
                                    <i class="bi bi-clock"></i> ${formatDate(post.createdAt)}
                                </small>
                            </a>
                        </div>
                        <button class="btn btn-sm btn-outline-danger ms-3 remove-bookmark-btn"
                                data-bookmark-id="${bookmark.id}"
                                data-post-id="${post.id}">
                            <i class="bi bi-bookmark-dash"></i> 삭제
                        </button>
                    </div>
                </div>
            `;
                }).join('');

                $('#bookmarks-list').html(bookmarksHtml);

            }).fail(function (xhr) {
                if (xhr.status === 401 || xhr.status === 403) {
                    location.href = '/login?redirect=/bookmarks';
                } else {
                    $('#bookmarks-list').html(`
                <div class="text-center py-5 text-danger">
                    북마크를 불러올 수 없습니다.
                </div>
            `);
                }
            });
        }

        // 북마크 삭제
        $(document).on('click', '.remove-bookmark-btn', function () {
            const bookmarkId = $(this).data('bookmark-id');
            const postId = $(this).data('post-id');

            if (!confirm('북마크를 삭제하시겠습니까?')) {
                return;
            }

            $.ajax({
                url: `/api/bookmarks/${postId}`,
                method: 'DELETE',
                success: function () {
                    loadBookmarks();
                },
                error: function (xhr) {
                    alert('삭제 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
                }
            });
        });

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60 * 1000) return '방금 전';
            if (diff < 60 * 60 * 1000) return `${Math.floor(diff / (60 * 1000))}분 전`;
            if (diff < 24 * 60 * 60 * 1000) return `${Math.floor(diff / (60 * 60 * 1000))}시간 전`;
            if (diff < 7 * 24 * 60 * 60 * 1000) return `${Math.floor(diff / (24 * 60 * 60 * 1000))}일 전`;

            return date.toLocaleDateString('ko-KR');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</th:block>
</body>
</html>