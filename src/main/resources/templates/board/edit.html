<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>게시글 수정</title>
</head>
<body>
<div layout:fragment="content">
    <h2>게시글 수정</h2>

    <form id="post-form">
        <div class="mb-3">
            <label for="category" class="form-label">카테고리</label>
            <select class="form-select" id="category" required>
                <option value="">선택하세요</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text" class="form-control" id="title" required maxlength="50">
        </div>

        <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea class="form-control" id="content" rows="10" required minlength="5"></textarea>
        </div>

        <div>
            <button type="submit" class="btn btn-primary">수정</button>
            <a th:href="@{/posts/{id}(id=${postId})}" class="btn btn-secondary">취소</a>
        </div>
    </form>
</div>

<th:block layout:fragment="script">
    <script th:inline="javascript">
        const postId = [[${postId}]];

        $(document).ready(function() {
            loadCategories();
            loadPost();
        });

        function loadCategories() {
            $.get('/api/categories', function(response) {
                const categories = response.data;
                const options = categories.map(cat =>
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');

                $('#category').append(options);
            }).fail(function() {
                alert('카테고리를 불러올 수 없습니다.');
            });
        }

        function loadPost() {
            $.get(`/api/posts/${postId}`, function(response) {
                const post = response.data;
                $('#category').val(post.category.id);
                $('#title').val(post.title);
                $('#content').val(post.content);
            }).fail(function(xhr) {
                if (xhr.status === 404) {
                    alert('존재하지 않는 게시글입니다.');
                    location.href = '/posts';
                } else if (xhr.status === 403) {
                    alert('수정 권한이 없습니다.');
                    location.href = `/posts/${postId}`;
                } else {
                    alert('게시글을 불러올 수 없습니다.');
                    location.href = '/posts';
                }
            });
        }

        $('#post-form').submit(function(e) {
            e.preventDefault();

            const data = {
                categoryId: parseInt($('#category').val()),
                title: $('#title').val(),
                content: $('#content').val()
            };

            $.ajax({
                url: `/api/posts/${postId}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function() {
                    alert('게시글이 수정되었습니다.');
                    location.href = `/posts/${postId}`;
                },
                error: function(xhr) {
                    alert('수정 실패: ' + (xhr.responseJSON?.message || '알 수 없는 오류'));
                }
            });
        });
    </script>
</th:block>
</body>
</html>