<!DOCTYPE html>
<html layout:decorate="~{layout/default}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>글쓰기</title>
</head>
<body>
<div layout:fragment="content">
    <h2>글쓰기</h2>

    <form id="post-form">
        <div class="mb-3">
            <label class="form-label" for="category">카테고리</label>
            <select class="form-select" id="category" required>
                <option value="">선택하세요</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label" for="title">제목</label>
            <input class="form-control" id="title" maxlength="50" required type="text">
        </div>

        <div class="mb-3">
            <label class="form-label" for="content">내용</label>
            <textarea class="form-control" id="content" minlength="5" required rows="10"></textarea>
        </div>

        <div>
            <button class="btn btn-primary" type="submit">작성</button>
            <a class="btn btn-secondary" th:href="@{/posts}">취소</a>
        </div>
    </form>
</div>

<th:block layout:fragment="script">
    <script>
        // 페이지 로드 시 카테고리 불러오기
        $(document).ready(function () {
            loadCategories();
        });

        function loadCategories() {
            $.get('/api/categories', function (response) {
                const categories = response.data;
                const options = categories.map(cat =>
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');

                $('#category').append(options);
            }).fail(function () {
                alert('카테고리를 불러올 수 없습니다.');
            });
        }

        $('#post-form').submit(function (e) {
            e.preventDefault();

            const data = {
                categoryId: $('#category').val(),
                title: $('#title').val(),
                content: $('#content').val()
            };

            $.ajax({
                url: '/api/posts',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    alert('게시글이 작성되었습니다.');
                    location.href = '/posts/' + response.data;
                },
                error: function (xhr) {
                    alert('작성 실패: ' + xhr.responseJSON.message);
                }
            });
        });
    </script>
</th:block>
</body>
</html>